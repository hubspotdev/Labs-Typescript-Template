name: Template Initialization

on:
  push:
    branches: [main, master]

jobs:
  initialize:
    # Only run if this is a new repo from template
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1
        with:
          fetch-depth: 0

      - name: Check if already initialized
        id: check
        run: |
          if [ -f .template-initialized ]; then
            echo "initialized=true" >> $GITHUB_OUTPUT
          else
            echo "initialized=false" >> $GITHUB_OUTPUT
          fi

      - name: Notify meta repo of new experiment
        if: steps.check.outputs.initialized == 'false'
        uses: peter-evans/repository-dispatch@ff45666b9427631e3450c54a1bcbee4d9ff4d7c0  # v3.0.0
        with:
          token: ${{ secrets.META_REPO_PAT }}
          repository: HubSpot/DevRel-Labs-Meta-Repo
          event-type: experiment-created-from-template
          client-payload: |
            {
              "repository": "${{ github.repository }}",
              "owner": "${{ github.repository_owner }}",
              "template": "java",
              "repo_url": "${{ github.event.repository.html_url }}",
              "created_at": "${{ github.event.repository.created_at }}"
            }

      - name: Create initialization marker
        if: steps.check.outputs.initialized == 'false'
        env:
          REPO_NAME: ${{ github.repository }}
        run: |
          # Use environment variables to prevent injection
          echo "Initialized from DevRel Labs template on $(date)" > .template-initialized
          echo "Repository: $REPO_NAME" >> .template-initialized

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .template-initialized
          git commit -m "Initialize from template [skip ci]"
          git push
